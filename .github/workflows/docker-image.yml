name: Docker Image CI

on:
  push:
    branches: [ github-actions ]
  pull_request:
    branches: [ master ]

jobs:

  build:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        image: [ubuntu2004-pfring, ubuntu2004-dpdk1911]

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    
    - name: Build image
      run: |
        docker build . --file Dockerfile-${{ matrix.image }} --tag seladb/${{ matrix.image }}:latest

    - name: Push to DockerHub
      run: |
        echo ${{ secrets.DOCKER_PASS }} | docker login -u ${{ secrets.DOCKER_USER }} --password-stdin
        docker push seladb/${{ matrix.image }}:latest

  test:
    needs: build
    runs-on: ubuntu-20.04
    container: seladb/${{ matrix.image }}
    strategy:
      matrix:
        image: [ubuntu2004, ubuntu2004-pfring, ubuntu2004-dpdk1911]

    steps:
    - name: Checkout PcapPlusPlus
      uses: actions/checkout@main
      with:
        repository: seladb/PcapPlusPlus
        path: ./PcapPlusPlus

    - name: Configure PcapPlusPlus
      working-directory: ./PcapPlusPlus
      run: |
        ./configure-linux.sh --default
  
    - name: Configure PcapPlusPlus with DPDK
      run: |
        ./configure-linux.sh --dpdk --dpdk-home /dpdk
      if: contains(matrix.image, 'dpdk')

    - name: Configure PcapPlusPlus with PF_RING
      run: |
        ./configure-linux.sh --pf-ring --pf-ring-home /PF_RING
      if: contains(matrix.image, 'pfring')

    - name: Build PcapPlusPlus
      working-directory: ./PcapPlusPlus
      run: make all

    - name: Test Packet++
      working-directory: ./PcapPlusPlus
      run: |
        cd Tests/Packet++Test
        Bin/Packet++Test

    - name: Test Pcap++
      working-directory: ./PcapPlusPlus
      run: |
        cd Tests/Pcap++Test
        Bin/Pcap++Test -n
